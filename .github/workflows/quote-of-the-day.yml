name: Quote of the Day

on:
  workflow_dispatch:
  schedule:
    - cron: "17 7 * * *" # daily

permissions:
  contents: write

concurrency:
  group: readme-update
  cancel-in-progress: false

jobs:
  update-quote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update README quote
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');

            const readmePath = 'README.md';
            const start = '<!--START_SECTION:quote-->';
            const end = '<!--END_SECTION:quote-->';

            function fetchJson(url) {
              return new Promise((resolve, reject) => {
                https
                  .get(url, (res) => {
                    let data = '';
                    res.on('data', (chunk) => (data += chunk));
                    res.on('end', () => {
                      try {
                        resolve(JSON.parse(data));
                      } catch (e) {
                        reject(e);
                      }
                    });
                  })
                  .on('error', reject);
              });
            }

            if (!fs.existsSync(readmePath)) {
              core.setFailed(`Missing ${readmePath}`);
              return;
            }

            const readme = fs.readFileSync(readmePath, 'utf8');
            if (!readme.includes(start) || !readme.includes(end)) {
              core.setFailed('Quote markers not found in README.');
              return;
            }

            let quote = { content: 'Build quietly. Ship relentlessly.', author: 'Prince' };
            try {
              const q = await fetchJson('https://api.quotable.io/random?tags=technology|wisdom|famous-quotes');
              if (q && q.content) {
                quote = { content: q.content, author: q.author || 'Unknown' };
              }
            } catch (e) {
              core.warning(`Quote fetch failed, using fallback. ${e.message}`);
            }

            const safeContent = String(quote.content).replace(/\s+/g, ' ').trim();
            const safeAuthor = String(quote.author).replace(/\s+/g, ' ').trim();

            const block = `${start}\n\n> *‚Äú${safeContent}‚Äù*\n\n‚Äî ${safeAuthor}\n\n${end}`;
            const next = readme.replace(new RegExp(`${start}[\\s\\S]*?${end}`, 'm'), block);

            if (next === readme) {
              core.info('README quote is already up to date.');
              return;
            }

            fs.writeFileSync(readmePath, next);

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üìù Update quote of the day"
          file_pattern: README.md
